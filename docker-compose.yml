version: '3.8'

services:
  mysql_db:
    image: mysql:8.0
    container_name: bc_handball_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: pcup_handball_is
      MYSQL_DATABASE: handball_is
      MYSQL_USER: user
      MYSQL_PASSWORD: pcup_handball_is
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: bc_handball_phpmyadmin
    restart: always
    depends_on:
      - mysql_db
    ports:
      - "8080:80"
    environment:
      PMA_HOST: mysql_db
      MYSQL_ROOT_PASSWORD: pcup_handball_is
      
  postgres_db:
    image: postgres:16
    container_name: bc_handball_pg
    restart: always
    environment:
      POSTGRES_PASSWORD: devpass
      POSTGRES_USER: devuser
      POSTGRES_DB: handball_is
    ports: [ "5432:5432" ]
    volumes: [ "pg_data:/var/lib/postgresql/data" ]

  pgadmin:
    image: dpage/pgadmin4
    depends_on: [ postgres_db ]
    environment:
      PGADMIN_DEFAULT_EMAIL: tomasp117@seznam.cz
      PGADMIN_DEFAULT_PASSWORD: pcup_handball_is
    ports: [ "5050:80" ]
    volumes:
      - pgadmin_data:/var/lib/pgadmin

# -- production -- 
  
#  pcup_fe:
#    build:
#      context: ../pcup_fe/pcup_fe
#    container_name: pcup_fe
#    restart: unless-stopped
#    ports:
#      - "3000:80" 

  bc_handball_be:
    volumes:
      - images_data:/app/wwwroot/images  
    build:
      context: .
      dockerfile: bc_handball_be.API/Dockerfile
    container_name: bc_handball_be
    restart: always
    depends_on:
      - mysql_db
    ports:
      - "5000:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: "Host=postgres_db;Port=5432;Database=handball_is;User=user;Password=pcup_handball_is"
    entrypoint: >
      sh -c "
      echo 'Waiting for MySQL...' &&
      sleep 10 &&
      dotnet bc_handball_be.API.dll
      "
  

volumes:
  mysql_data:
  images_data:
  pg_data:
  pgadmin_data: